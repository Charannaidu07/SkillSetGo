<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments | SkillSetGo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #4e73df;
            --text-dark: #2d3748;
            --text-light: #f8f9fa;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --transition-base: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: var(--primary-gradient);
            box-shadow: var(--shadow-lg);
            padding: 0.8rem 2rem;
            transition: var(--transition-base);
            position: relative;
            z-index: 1000;
        }

        .main-container {
            flex: 1;
            padding: 2rem 0;
            background-color: #f8f9fa;
        }

        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .appointments-grid {
                grid-template-columns: 1fr;
            }
        }

        .appointment-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: var(--transition-base);
            border-left: 4px solid var(--accent-color);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .appointment-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .appointment-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
            color: var(--text-dark);
        }

        .appointment-status {
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .appointment-details {
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }

        .appointment-detail {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .appointment-detail i {
            width: 20px;
            margin-right: 0.75rem;
            color: var(--accent-color);
        }

        .appointment-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .appointment-price {
            font-weight: 600;
            color: var(--accent-color);
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-completed {
            background-color: #28a745;
            color: #fff;
        }

        .status-accepted {
            background-color: #007bff;
            color: #fff;
        }

        .status-cancelled {
            background-color: #dc3545;
            color: #fff;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .appointment-modal .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .appointment-modal .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 12px 12px 0 0;
            border-bottom: none;
        }

        .appointment-modal .modal-body {
            padding: 2rem;
        }

        .detail-row {
            display: flex;
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-dark);
            min-width: 150px;
        }

        .detail-value {
            flex: 1;
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .image-gallery .gallery-item {
            flex: 1 1 calc(50% - 16px);
            min-width: 0;
        }

        .image-thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            aspect-ratio: 1 / 1;
        }

        .no-images {
            color: #6c757d;
            font-style: italic;
        }

        .bargaining-history {
            border-top: 1px solid #eee;
            padding-top: 1rem;
            margin-top: 1.5rem;
        }

        .bargain-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e0e0e0;
            box-shadow: var(--shadow-sm);
        }

        .bargain-item.accepted {
            background-color: #e8f5e9;
            border-left: 3px solid #28a745;
        }

        .bargain-item.rejected {
            background-color: #ffebee;
            border-left: 3px solid #dc3545;
        }

        .bargain-item.pending {
            background-color: #fffde7;
            border-left: 3px solid #ffc107;
        }

        .bargain-item.user_accepted {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        .bargain-item.servicer_accepted {
            background-color: #e0f7fa;
            border-left: 3px solid #00bcd4;
        }

        .bargain-price {
            font-weight: 600;
        }

        .bargain-message {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .bargain-meta {
            font-size: 0.75rem;
            color: #adb5bd;
            margin-top: 0.5rem;
        }

        .bargain-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .price-comparison {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .otp-section {
            background-color: #f0f8ff;
            border: 1px solid #cceeff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .otp-section h6 {
            color: var(--primary-gradient);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .otp-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
            letter-spacing: 0.1em;
            text-align: center;
            padding: 0.5rem;
            border: 2px dashed #28a745;
            border-radius: 5px;
            display: inline-block;
            background-color: #e9ffe9;
        }

        .otp-input-group {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }

        .total-price-section {
            background-color: #e6ffe6;
            border: 1px solid #a3e9a4;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .total-price-section h6 {
            color: #28a745;
            font-weight: 600;
        }
        .total-price-section p {
            margin-bottom: 0.5rem;
        }
        .total-price-section strong {
            color: #007bff;
        }
        .total-price-section .servicer-earnings {
            color: #dc3545;
        }

        .rating-section {
            background-color: #f7f7f7;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: center;
        }

        .rating-section .stars {
            font-size: 2.5rem;
            color: #ffc107;
            cursor: pointer;
        }

        .rating-section .star {
            transition: color 0.2s;
        }

        .rating-section .star.selected,
        .rating-section .star:hover {
            color: #ffc107;
        }

        .rating-section .star:not(.selected):hover ~ .star {
            color: #e0e0e0;
        }

    </style>
</head>
<body>
    {% include 'header.html' %}

    <main class="main-container">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    {% if user.user_type == 'servicer' and not provider.is_verified %}
                    <div class="alert alert-warning">
                        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Account Not Verified</h5>
                        <p>Your service provider account is not yet verified. Please complete your profile and verification process to access appointments.</p>
                        <hr>
                        <a href="{% url 'service_provider_dashboard' %}" class="btn btn-sm btn-warning">Complete Verification</a>
                    </div>
                    {% endif %}

                    <h4 class="section-title"><i class="fas fa-calendar-check me-2"></i> Your Appointments</h4>

                    <div class="appointments-grid">
                        {% if appointments %}
                            {% for appointment in appointments %}
                            <div class="appointment-card animate__animated animate__fadeInUp">
                                <div class="appointment-header">
                                    <h5 class="appointment-title">
                                        {% if appointment.issue == 'others' %}
                                            {{ appointment.custom_issue }}
                                        {% else %}
                                            {{ appointment.get_issue_display }}
                                        {% endif %}
                                    </h5>
                                    <span class="appointment-status
                                        {% if appointment.status == 'completed' %}status-completed
                                        {% elif appointment.status == 'pending' %}status-pending
                                        {% elif appointment.status == 'accepted' %}status-accepted
                                        {% else %}status-cancelled{% endif %}">
                                        {{ appointment.get_status_display }}
                                    </span>
                                </div>

                                <div class="appointment-details">
                                    <div class="appointment-detail">
                                        <i class="fas fa-user"></i>
                                        <span>{{ appointment.full_name }}</span>
                                    </div>
                                    <div class="appointment-detail">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ appointment.expected_time|date:"F j, Y" }} at {{ appointment.expected_time|time:"g:i A" }}</span>
                                    </div>
                                    <div class="appointment-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ appointment.address|truncatechars:40 }}</span>
                                    </div>
                                </div>

                                <div class="appointment-footer">
                                    <div class="appointment-price">
                                        <i class="fas fa-rupee-sign"></i> {{ appointment.expected_amount }}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2"
                                                data-bs-toggle="modal"
                                                data-bs-target="#appointmentModal"
                                                onclick="loadAppointmentDetails({{ appointment.id }})">
                                            Details
                                        </button>
                                        {% if appointment.status == 'pending' and user.user_type == 'servicer' %}
                                            <button class="btn btn-sm btn-success" onclick="acceptAppointmentConfirmation({{ appointment.id }})">Accept Initial Price</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="far fa-calendar-times fa-3x mb-3 text-muted"></i>
                                <h5>No Appointments Found</h5>
                                <p class="text-muted mb-4">You don't have any appointments scheduled yet.</p>
                                {% if user.user_type == 'servicer' %}
                                <a href="{% url 'service_provider_dashboard' %}" class="btn btn-primary">Go to Dashboard</a>
                                {% else %}
                                <a href="{% url 'book_appointment' %}" class="btn btn-primary">Book New Appointment</a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade appointment-modal" id="appointmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Appointment Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="detail-row">
                        <div class="detail-label">Service Type:</div>
                        <div class="detail-value" id="detail-issue"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Customer Name:</div>
                        <div class="detail-value" id="detail-customer"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Contact Number:</div>
                        <div class="detail-value" id="detail-contact"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Booking Id:</div>
                        <div class="detail-value" id="detail-booking"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Scheduled Time:</div>
                        <div class="detail-value" id="detail-time"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Expected Budget:</div>
                        <div class="detail-value" id="detail-amount"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value" id="detail-description"></div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Location:</div>
                        <div class="detail-value" id="detail-location"></div>
                    </div>

                    <div id="servicerDetailsSection" style="display: none;">
                        <h6 class="mt-4 mb-3">Assigned Servicer Details:</h6>
                        <p><strong>Servicer ID:</strong> <span id="servicer-id"></span></p>
                        <p><strong>Name:</strong> <span id="servicer-name"></span></p>
                        <p><strong>Mobile:</strong> <span id="servicer-mobile"></span></p>
                        <p><strong>WhatsApp:</strong> <span id="servicer-whatsapp"></span></p>
                        <p><strong>Address:</strong> <span id="servicer-address"></span></p>
                        <p><strong>Rating:</strong> <span id="servicer-rating"></span></p>
                    </div>

                    <div id="totalPriceSection" style="display: none;" class="total-price-section">
                        <h6 class="mt-4 mb-3">Total Cost & Earnings:</h6>
                        <p><strong>Final Agreed Price:</strong> <span id="final-agreed-price"></span></p>
                        <p><strong>Distance Cost (₹5/km):</strong> <span id="distance-cost"></span></p>
                        <p><strong>Platform Fee (User):</strong> <span id="platform-fee-user"></span></p>
                        <p><strong>Your Total Price:</strong> <strong id="user-total-price"></strong></p>
                        <p><strong>Platform Fee (Servicer):</strong> <span id="platform-fee-servicer"></span></p>
                        <p><strong class="servicer-earnings">Servicer Earnings:</strong> <strong id="servicer-earnings"></strong></p>
                    </div>

                    <div id="otpSection" style="display: none;" class="otp-section">
                        <h6 class="mt-4 mb-3">Appointment Verification:</h6>
                        <div id="otpDisplay" style="display: none;">
                            <p>Please provide this OTP to the Servicer after work completion:</p>
                            <span class="otp-display" id="generated-otp"></span>
                        </div>
                        <div id="otpVerification" style="display: none;">
                            <p>Enter OTP provided by the User to mark as completed:</p>
                            <input type="text" class="form-control otp-input" id="servicer-otp-input" maxlength="6" placeholder="Enter OTP">
                            <button class="btn btn-primary mt-2" onclick="verifyOtp()">Verify OTP</button>
                        </div>
                        <p class="text-danger mt-2" id="otp-error" style="display: none;"></p>
                    </div>

                    <div id="ratingSection" style="display: none;" class="rating-section">
                        <h6>Rate the Servicer (1-5 Stars)</h6>
                        <div class="stars" id="servicer-stars">
                            <i class="far fa-star star" data-rating="1"></i>
                            <i class="far fa-star star" data-rating="2"></i>
                            <i class="far fa-star star" data-rating="3"></i>
                            <i class="far fa-star star" data-rating="4"></i>
                            <i class="far fa-star star" data-rating="5"></i>
                        </div>
                        <button class="btn btn-primary mt-3" id="submitRatingBtn" onclick="submitRating()">Submit Rating</button>
                        <p class="text-info mt-2" id="rating-message" style="display: none;"></p>
                    </div>

                    <h6 class="mt-4 mb-3">Images:</h6>
                    <div class="image-gallery" id="detail-images">
                        </div>

                    <div class="bargaining-history">
                        <h6 class="mb-3">Price Negotiation History</h6>
                        <div id="bargainHistory">
                            </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bargainModal"
                            id="bargainButton" style="display: none;">
                        Bargain Price
                    </button>
                    <button class="btn btn-success" id="acceptAppointmentBtn" style="display: none;">
                        Confirm Final Price
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bargainModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Negotiate Price</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Initial Price:</label>
                        <input type="text" class="form-control" id="initialPrice" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Your Offer:</label>
                        <input type="number" class="form-control" id="offerPrice" placeholder="Enter your offer price">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message (Optional):</label>
                        <textarea class="form-control" id="offerMessage" rows="3" placeholder="Add any notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitBargain()">Submit Offer</button>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Animation for cards when they come into view
    document.addEventListener('DOMContentLoaded', function() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.appointment-card').forEach(card => {
            observer.observe(card);
        });
    });

    let currentAppointmentId = null;
    let initialPrice = 0;
    const isServicer = {% if user.user_type == 'servicer' %}true{% else %}false{% endif %};
    const currentUserId = {{ user.id }}; // Get current user's ID
    let selectedRating = 0; // To store the rating selected by the user

    function prepareBargain(appointmentId, price) {
        currentAppointmentId = appointmentId;
        initialPrice = price;
        const initialPriceElem = document.getElementById('initialPrice');
        if (initialPriceElem) initialPriceElem.value = '₹' + price;
        const offerPriceElem = document.getElementById('offerPrice');
        if (offerPriceElem) offerPriceElem.value = '';
        const offerMessageElem = document.getElementById('offerMessage');
        if (offerMessageElem) offerMessageElem.value = '';
    }

    function submitBargain() {
        const offerPriceElem = document.getElementById('offerPrice');
        const offerMessageElem = document.getElementById('offerMessage');

        const offerPrice = offerPriceElem ? offerPriceElem.value : '';
        const offerMessage = offerMessageElem ? offerMessageElem.value : '';

        if (!offerPrice || isNaN(offerPrice) || parseFloat(offerPrice) <= 0) {
            alert('Please enter a valid positive price.');
            return;
        }

        const payload = {
            appointment_id: currentAppointmentId,
            message: offerMessage
        };

        if (isServicer) {
            payload.servicer_offer = offerPrice;
        } else {
            payload.user_offer = offerPrice;
        }

        fetch('/api/bargain/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Your offer has been submitted!');
                const bargainModalElement = document.getElementById('bargainModal');
                const bargainModal = bootstrap.Modal.getInstance(bargainModalElement) || new bootstrap.Modal(bargainModalElement);
                bargainModal.hide();

                loadAppointmentDetails(currentAppointmentId);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error submitting offer:', error);
            alert('Failed to submit offer: ' + error.message);
        });
    }

    function acceptOffer(bargainId) {
        fetch(`/api/bargain/${bargainId}/accept/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Offer accepted!');
                loadAppointmentDetails(currentAppointmentId);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error accepting offer:', error);
            alert('Failed to accept offer: ' + error.message);
        });
    }

    function rejectOffer(bargainId) {
        if (!confirm('Are you sure you want to reject this offer?')) return;

        fetch(`/api/bargain/${bargainId}/reject/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Offer rejected');
                loadAppointmentDetails(currentAppointmentId);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error rejecting offer:', error);
            alert('Failed to reject offer: ' + error.message);
        });
    }

    function acceptAppointmentConfirmation(appointmentId) {
        if (confirm('Are you sure you want to accept this appointment at the requested price?')) {
            fetch(`/api/appointments/${appointmentId}/accept/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Appointment accepted successfully!');
                    const appointmentModalElement = document.getElementById('appointmentModal');
                    const appointmentModal = bootstrap.Modal.getInstance(appointmentModalElement) || new bootstrap.Modal(appointmentModalElement);
                    appointmentModal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error accepting appointment:', error);
                alert('Failed to accept appointment: ' + error.message);
            });
        }
    }

    function confirmFinalPrice(appointmentId) {
        if (confirm('Are you sure you want to confirm the final agreed price and accept this appointment?')) {
            fetch(`/api/appointments/${appointmentId}/confirm/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Appointment confirmed successfully at the final price!');
                    const appointmentModalElement = document.getElementById('appointmentModal');
                    const appointmentModal = bootstrap.Modal.getInstance(appointmentModalElement) || new bootstrap.Modal(appointmentModalElement);
                    appointmentModal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error confirming final price:', error);
                alert('Failed to confirm appointment at final price: ' + error.message);
            });
        }
    }

    // OTP Verification
    function verifyOtp() {
        const otpInputElem = document.getElementById('servicer-otp-input');
        const otpErrorElem = document.getElementById('otp-error');
        const otpInput = otpInputElem ? otpInputElem.value : '';

        if (otpErrorElem) otpErrorElem.style.display = 'none';

        if (!otpInput) {
            if (otpErrorElem) {
                otpErrorElem.textContent = 'Please enter the OTP.';
                otpErrorElem.style.display = 'block';
            }
            return;
        }

        fetch(`/api/appointments/${currentAppointmentId}/verify-otp/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ otp: otpInput })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                const appointmentModalElement = document.getElementById('appointmentModal');
                const appointmentModal = bootstrap.Modal.getInstance(appointmentModalElement) || new bootstrap.Modal(appointmentModalElement);
                appointmentModal.hide();
                location.reload();
            } else {
                if (otpErrorElem) {
                    otpErrorElem.textContent = data.error;
                    otpErrorElem.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error verifying OTP:', error);
            if (otpErrorElem) {
                otpErrorElem.textContent = 'Failed to verify OTP: ' + error.message;
                otpErrorElem.style.display = 'block';
            }
        });
    }

    // Rating functionality
    function setupRatingStars(initialRating = 0) {
        const starsContainer = document.getElementById('servicer-stars');
        if (!starsContainer) return;

        starsContainer.innerHTML = '';
        selectedRating = initialRating;

        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('i');
            star.classList.add('far', 'fa-star', 'star');
            if (i <= selectedRating) {
                star.classList.remove('far');
                star.classList.add('fas', 'selected');
            }
            star.setAttribute('data-rating', i);
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.getAttribute('data-rating'));
                updateStarDisplay();
            });
            star.addEventListener('mouseover', function() {
                highlightStars(parseInt(this.getAttribute('data-rating')));
            });
            star.addEventListener('mouseout', function() {
                updateStarDisplay();
            });
            starsContainer.appendChild(star);
        }
        updateStarDisplay();
    }

    function updateStarDisplay() {
        const stars = document.querySelectorAll('#servicer-stars .star');
        stars.forEach(star => {
            const rating = parseInt(star.getAttribute('data-rating'));
            if (rating <= selectedRating) {
                star.classList.remove('far');
                star.classList.add('fas', 'selected');
            } else {
                star.classList.remove('fas', 'selected');
                star.classList.add('far');
            }
        });
    }

    function highlightStars(hoverRating) {
        const stars = document.querySelectorAll('#servicer-stars .star');
        stars.forEach(star => {
            const rating = parseInt(star.getAttribute('data-rating'));
            if (rating <= hoverRating) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });
    }

    function submitRating() {
        const ratingMessageElem = document.getElementById('rating-message');
        if (ratingMessageElem) ratingMessageElem.style.display = 'none';

        if (selectedRating === 0) {
            if (ratingMessageElem) {
                ratingMessageElem.textContent = 'Please select a rating before submitting.';
                ratingMessageElem.classList.remove('text-success');
                ratingMessageElem.classList.add('text-danger');
                ratingMessageElem.style.display = 'block';
            }
            return;
        }

        fetch(`/api/appointments/${currentAppointmentId}/rate-servicer/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ rating: selectedRating })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (ratingMessageElem) {
                    ratingMessageElem.textContent = data.message;
                    ratingMessageElem.classList.remove('text-danger');
                    ratingMessageElem.classList.add('text-success');
                    ratingMessageElem.style.display = 'block';
                }
                document.getElementById('submitRatingBtn').disabled = true;
                loadAppointmentDetails(currentAppointmentId);
            } else {
                if (ratingMessageElem) {
                    ratingMessageElem.textContent = data.error;
                    ratingMessageElem.classList.remove('text-success');
                    ratingMessageElem.classList.add('text-danger');
                    ratingMessageElem.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error submitting rating:', error);
            if (ratingMessageElem) {
                ratingMessageElem.textContent = 'Failed to submit rating: ' + error.message;
                ratingMessageElem.style.display = 'block';
            }
        });
    }

    function loadAppointmentDetails(appointmentId) {
        currentAppointmentId = appointmentId;

        // Clear previous content
        const detailImages = document.getElementById('detail-images');
        if (detailImages) detailImages.innerHTML = '';
        const bargainHistory = document.getElementById('bargainHistory');
        if (bargainHistory) bargainHistory.innerHTML = '';

        // Fetch appointment details
        fetch(`/api/appointments/${appointmentId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch appointment details');
                }
                return response.json();
            })
            .then(data => {
                // Populate modal with data
                document.getElementById('detail-issue').textContent =
                    data.issue === 'others' ? data.custom_issue : data.issue_display;
                document.getElementById('detail-customer').textContent = data.full_name;
                document.getElementById('detail-contact').textContent = data.contact_number;
                document.getElementById('detail-booking').textContent = data.booking_id;

                const detailTimeElem = document.getElementById('detail-time');
                if (detailTimeElem && data.expected_time) {
                    detailTimeElem.textContent = new Date(data.expected_time).toLocaleString();
                } else if (detailTimeElem) {
                    detailTimeElem.textContent = 'N/A';
                }

                document.getElementById('detail-amount').textContent =
                    '₹' + parseFloat(data.expected_amount).toFixed(2);
                document.getElementById('detail-description').textContent = data.description;
                document.getElementById('detail-location').textContent =
                    `${data.address}, ${data.city}, ${data.state} - ${data.pincode}, ${data.country}`;

                // Handle Servicer Details
                const servicerDetailsSection = document.getElementById('servicerDetailsSection');
                if (servicerDetailsSection) {
                    if (data.servicer_details) { // Changed condition to just check if servicer_details exists
                        document.getElementById('servicer-id').textContent = data.servicer_details.id;
                        document.getElementById('servicer-name').textContent = data.servicer_details.full_name;
                        document.getElementById('servicer-mobile').textContent = data.servicer_details.mobile_number;
                        document.getElementById('servicer-whatsapp').textContent = data.servicer_details.whatsapp_number;
                        document.getElementById('servicer-address').textContent = data.servicer_details.address;
                        document.getElementById('servicer-rating').textContent = data.servicer_details.rating + ' ★';
                        servicerDetailsSection.style.display = 'block';
                    } else {
                        servicerDetailsSection.style.display = 'none';
                    }
                }

                // Handle Total Price Section
                const totalPriceSection = document.getElementById('totalPriceSection');
                if (totalPriceSection) {
                    if ((data.status === 'accepted' || data.status === 'completed') && data.user_total_price && data.servicer_earnings) {
                        document.getElementById('final-agreed-price').textContent = '₹' + parseFloat(data.expected_amount).toFixed(2);
                        document.getElementById('distance-cost').textContent = data.distance_cost || 'N/A';
                        document.getElementById('platform-fee-user').textContent = data.platform_fee_user || 'N/A';
                        document.getElementById('user-total-price').textContent = data.user_total_price;
                        document.getElementById('platform-fee-servicer').textContent = data.platform_fee_servicer || 'N/A';
                        document.getElementById('servicer-earnings').textContent = data.servicer_earnings;
                        totalPriceSection.style.display = 'block';
                    } else {
                        totalPriceSection.style.display = 'none';
                    }
                }


                // Handle OTP Section
                const otpSection = document.getElementById('otpSection');
                const otpDisplay = document.getElementById('otpDisplay');
                const otpVerification = document.getElementById('otpVerification');
                const servicerOtpInput = document.getElementById('servicer-otp-input');
                const otpError = document.getElementById('otp-error');

                if (otpSection) otpSection.style.display = 'none';
                if (otpDisplay) otpDisplay.style.display = 'none';
                if (otpVerification) otpVerification.style.display = 'none';
                if (otpError) otpError.style.display = 'none';
                if (servicerOtpInput) servicerOtpInput.value = '';

                // Show OTP section if status is 'accepted' AND not yet OTP verified
                if (data.status === 'accepted' && !data.otp_verified) {
                    if (otpSection) otpSection.style.display = 'block';
                    if (!isServicer) { // Regular User: Show generated OTP
                        if (otpDisplay) {
                            otpDisplay.style.display = 'block';
                            document.getElementById('generated-otp').textContent = data.otp || 'N/A';
                        }
                    } else { // Servicer: Show OTP input for verification
                        const assignedServicerId = data.servicer_details ? data.servicer_details.id : null;
                        const currentServicerId = {% if user.user_type == 'servicer' and user.service_provider %} '{{ user.service_provider.service_provider_id }}' {% else %} null {% endif %};
                        if (assignedServicerId === currentServicerId) {
                            if (otpVerification) otpVerification.style.display = 'block';
                        }
                    }
                }

                // Handle Rating Section (moved logic here for clarity)
                const ratingSection = document.getElementById('ratingSection');
                const submitRatingBtn = document.getElementById('submitRatingBtn');
                const ratingMessageElem = document.getElementById('rating-message');

                if (ratingSection) ratingSection.style.display = 'none'; // Always hide first
                if (ratingMessageElem) ratingMessageElem.style.display = 'none'; // Hide messages

                // Condition for showing the rating section:
                // 1. Appointment status is 'completed'
                // 2. Current user is a 'user' (not servicer)
                // 3. A servicer was actually assigned (data.servicer_details exists)
                if (data.status === 'completed' && !isServicer && data.servicer_details) {
                    if (ratingSection) ratingSection.style.display = 'block';
                    if (submitRatingBtn) {
                        submitRatingBtn.disabled = false; // Enable by default
                    }
                    if (data.appointment_rating) {
                        // If already rated, display the rating and disable submission
                        setupRatingStars(data.appointment_rating);
                        if (submitRatingBtn) submitRatingBtn.disabled = true;
                        if (ratingMessageElem) {
                            ratingMessageElem.textContent = `You rated this servicer ${data.appointment_rating} star(s).`;
                            ratingMessageElem.classList.remove('text-danger');
                            ratingMessageElem.classList.add('text-info');
                            ratingMessageElem.style.display = 'block';
                        }
                    } else {
                        // If not rated, enable rating submission
                        setupRatingStars(0); // Initialize with 0 for unrated
                    }
                } else {
                    if (ratingSection) ratingSection.style.display = 'none'; // Ensure it's hidden if conditions not met
                }

                // Handle images
                const imageGallery = document.getElementById('detail-images');
                if (imageGallery) {
                    const images = [data.image1, data.image2, data.image3, data.image4]
                        .filter(img => img !== null && img.trim() !== '');

                    if (images.length > 0) {
                        images.forEach(imgUrl => {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'gallery-item';

                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.className = 'image-thumbnail';
                            img.alt = 'Appointment image';
                            img.loading = 'lazy';

                            imgContainer.appendChild(img);
                            imageGallery.appendChild(imgContainer);
                        });
                    } else {
                        const noImages = document.createElement('p');
                        noImages.className = 'no-images';
                        noImages.textContent = 'No images provided';
                        imageGallery.appendChild(noImages);
                    }
                }

                // Handle bargaining history and buttons
                const bargainBtn = document.getElementById('bargainButton');
                const acceptAppointmentBtn = document.getElementById('acceptAppointmentBtn');

                if (bargainBtn) {
                    if (data.status === 'pending') {
                        const lastBargain = data.bargaining_history.length > 0 ? data.bargaining_history[0] : null;
                        if (!isServicer || (isServicer && (!lastBargain || lastBargain.offered_by === 'servicer' || lastBargain.status !== 'pending'))) {
                             bargainBtn.style.display = 'inline-block';
                        } else {
                            bargainBtn.style.display = 'none';
                        }

                        bargainBtn.onclick = function() {
                            prepareBargain(data.id, parseFloat(data.expected_amount));
                        };

                        if (acceptAppointmentBtn) {
                            if (isServicer && data.bargaining_history.length === 0 && data.status === 'pending') {
                                acceptAppointmentBtn.style.display = 'inline-block';
                                acceptAppointmentBtn.onclick = function() {
                                    acceptAppointmentConfirmation(data.id);
                                };
                            } else {
                                acceptAppointmentBtn.style.display = 'none';
                            }
                        }

                    } else {
                        bargainBtn.style.display = 'none';
                        if (acceptAppointmentBtn) acceptAppointmentBtn.style.display = 'none';
                    }
                }

                const bargainHistoryContainer = document.getElementById('bargainHistory');
                if (bargainHistoryContainer) {
                    if (data.bargaining_history && data.bargaining_history.length > 0) {
                        renderBargainHistory(data.bargaining_history, data.status);
                    } else {
                        bargainHistoryContainer.innerHTML = '<p class="text-muted">No negotiation history yet</p>';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching appointment details:', error);
                alert('Failed to load appointment details: ' + error.message);
            });
    }

    function getStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'accepted': return 'primary';
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }

    function getBargainStatusColor(status) {
        switch(status) {
            case 'pending': return 'warning';
            case 'accepted': return 'success';
            case 'rejected': return 'danger';
            case 'user_accepted': return 'info';
            case 'servicer_accepted': return 'primary';
            default: return 'secondary';
        }
    }

    function renderBargainHistory(history, appointmentStatus) {
        const container = document.getElementById('bargainHistory');
        if (!container) return;
        container.innerHTML = '';

        let latestRelevantPendingOffer = null;
        if (appointmentStatus === 'pending') {
            if (isServicer) {
                for (let i = 0; i < history.length; i++) {
                    if (history[i].offered_by === 'user' && history[i].status === 'pending') {
                        latestRelevantPendingOffer = history[i];
                        break;
                    }
                }
            } else {
                for (let i = 0; i < history.length; i++) {
                    if (history[i].offered_by === 'servicer' && history[i].status === 'pending') {
                        latestRelevantPendingOffer = history[i];
                        break;
                    }
                }
            }
        }


        history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = `bargain-item ${item.status.replace('_', '-')}`;

            let offerPrice;
            if (item.offered_by === 'servicer') {
                offerPrice = item.servicer_offer_price;
            } else {
                offerPrice = item.user_offer_price;
            }

            const initialPriceFormatted = parseFloat(item.initial_price).toFixed(2);
            const offerPriceFormatted = (offerPrice !== null && offerPrice !== 'None' && offerPrice !== undefined) ? parseFloat(offerPrice).toFixed(2) : 'N/A';

            let servicerDetailsHtml = '';
            if (item.offered_by === 'servicer' && item.servicer_info) {
                servicerDetailsHtml = `
                    <small class="text-muted">
                        Servicer: ${item.servicer_info.full_name} (ID: ${item.servicer_info.id})
                        ${item.servicer_info.rating ? `★ ${item.servicer_info.rating}` : ''}
                    </small><br>
                `;
            }

            let priceHtml = `
                <div class="price-comparison">
                    <span class="bargain-price">₹${initialPriceFormatted}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span class="bargain-price">₹${offerPriceFormatted}</span>
                </div>
            `;

            let actionButtons = '';
            if (appointmentStatus === 'pending' && latestRelevantPendingOffer && latestRelevantPendingOffer.id === item.id) {
                actionButtons = `
                    <div class="bargain-actions">
                        <button class="btn btn-sm btn-success"
                                onclick="acceptOffer(${item.id})">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="btn btn-sm btn-danger"
                                onclick="rejectOffer(${item.id})">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                `;
            }

            historyItem.innerHTML = `
                ${priceHtml}
                <div class="bargain-meta">
                    ${servicerDetailsHtml}
                    Offered by ${item.offered_by === 'servicer' ? 'Servicer' : 'You'}
                    on ${new Date(item.created_at).toLocaleString()}
                    <span class="badge bg-${getBargainStatusColor(item.status)} ms-2">${item.status_display}</span>
                </div>
                ${item.message ? `<div class="bargain-message">${item.message}</div>` : ''}
                ${actionButtons}
            `;
            container.appendChild(historyItem);
        });
    }
</script>
</body>
</html>